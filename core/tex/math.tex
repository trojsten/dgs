%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Operators %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NewDocumentCommand{\diff}{}{\mathop{}\!\mathrm{d}}
\NewDocumentCommand{\pdiff}{}{\mathop{}\!\partial}
\NewDocumentCommand{\fdiff}{}{\mathop{}\!\Delta}
\DeclareMathOperator{\sdiff}{\delta\!}
\DeclareMathOperator{\laplacian}{\Delta\!}
\DeclareMathOperator{\del}{\raisebox{0.06em}{\ensuremath{\vec{\nabla}}}}
\DeclareMathOperator{\Grad}{\del}
\DeclareMathOperator{\Div}{\del\cdot}
\DeclareMathOperator{\Rot}{\del\times}

\DeclareMathOperator{\atantwo}{atan2}

\DeclareMathOperator{\maxop}{max\ }
\DeclareMathOperator{\minop}{min\ }

\DeclareMathOperator{\LXor}{\quad\lxor\quad}
\DeclareMathOperator{\LOr}{\quad\lor\quad}
\DeclareMathOperator{\LAnd}{\quad\land\quad}
\DeclareMathOperator{\LNand}{\quad\lnand\quad}

\DeclareMathOperator{\sinc}{sinc}
\DeclareMathOperator{\hav}{hav}

\NewDocumentCommand{\Diff}{O{}}{%
    \IfNoValueTF{#1}{\diff}{\diff^{#1}}%
}

% Inner derivative with any differential symbol
\NewDocumentCommand{\Deriv}{O{} m m m}{%
    \ifblank{#1}{%
        \frac{#2#3}{#2#4}%
    }{%
        \frac{#2^{#1}#3}{#2{#4}^{#1}}%
    }%
}

\NewDocumentCommand{\DerivEmpty}{O{} m m}{%
    \ifblank{#1}{%
        \frac{#2}{#2#3}
    }{%
        \frac{#2^{#1}}{#2#3^{#1}}
    }%
}

\NewDocumentCommand{\DerivParen}{O{} m m m}{%
    \ifblank{#1}{%
        \frac{#2}{#2#3}\left(#4\right)%
    }{%
        \frac{#2^{#1}}{#2#3^{#1}}\left(#4\right)%
    }%
}

% \Derivative[order]{what}{by-what}
\NewDocumentCommand{\Derivative}{O{} m m}{\Deriv[#1]{\diff}{#2}{#3}}
\NewDocumentCommand{\PDerivative}{O{} m m}{\Deriv[#1]{\pdiff}{#2}{#3}}
\NewDocumentCommand{\FDerivative}{O{} m m}{\Deriv[#1]{\fdiff}{#2}{#3}}

% \DerivativeEmpty[order]{by-what}
\NewDocumentCommand{\DerivativeE}{O{} m}{\DerivEmpty[#1]{\diff}{#2}}
\NewDocumentCommand{\PDerivativeE}{O{} m}{\DerivEmpty[#1]{\pdiff}{#2}}
\NewDocumentCommand{\FDerivativeE}{O{} m}{\DerivEmpty[#1]{\fdiff}{#2}}

% \DerivativeParentheses{what}{by-what}
\NewDocumentCommand{\DerivativeP}{O{} m m}{\DerivParen[#1]{\diff}{#2}{#3}}
\NewDocumentCommand{\PDerivativeP}{O{} m m}{\DerivParen[#1]{\diff}{#2}{#3}}
\NewDocumentCommand{\FDerivativeP}{O{} m m}{\DerivParen[#1]{\diff}{#2}{#3}}


% \DerivativeEvaluate[order]{what}{by-what}{where}
% \DerivativeEval[2]{f(x)}{x}{0} is second derivative of f(x) at x = 0
\NewDocumentCommand{\DerivativeEval}{O{} m m m}{%
    \EvalAt{\Derivative[#1]{#2}{#3}}{#3 = #4}%
}%

% \PartialDerivativeEvaluate[order]{what}{by-what}{where}
% \PDerivativeEval[2]{f(x)}{x}{0} is second derivative of f(x) at x = 0
\NewDocumentCommand{\PDerivativeEval}{O{} m m m}{%
    \EvalAt{\PDerivative[#1]{#2}{#3}}{#3 = #4}%
}%

\NewDocumentCommand{\ArrowVector}{m}{\vv{#1}}
\NewDocumentCommand{\BoldVector}{m}{\mathbf{#1}}
\NewDocumentCommand{\UnitVector}{m}{\hat{\vec{#1}}}
\NewDocumentCommand{\UnitBoldVector}{m}{\hat{\BoldVector{#1}}}
\NewDocumentCommand{\UnitArrowVector}{m}{\hat{#1}}

\NewDocumentCommand{\EvalAt}{m m}{\left.#1\right|_{#2}}
\NewDocumentCommand{\EvalFromTo}{m m m}{\left.#1\right|_{#2}^{#3}}
\NewDocumentCommand{\ExpectedChevrons}{m}{\left<#1\right>}
\NewDocumentCommand{\ExpectedE}{m}{\mathbb{E}\left[#1\right]}
\NewDocumentCommand{\Mean}{m}{\overline{#1}}

\makeatletter
% Generic 1D integral
\NewDocumentCommand{\Int@}{O{} O{} m m O{}}{\int\limits_{#1}^{#2} #3#5\diff#4}
% Integral from #1 to #2 of #3 with respect to #4
\NewDocumentCommand{\Int}{O{} O{} m m}{\Int@[#1][#2]{#3}{#4}[]}
% Integral from #1 to #2 of dot product of #3 and d#4
\NewDocumentCommand{\IntD}{O{} O{} m m}{\Int@[#1][#2]{#3}{#4}[\cdot]}
% Integral from #1 to #2 of cross product of #3 and d#4 (
\NewDocumentCommand{\IntC}{O{} O{} m m}{\Int@[#1][#2]{#3}{#4}[\times]}

% Generic loop integral
\NewDocumentCommand{\OInt@}{O{} m m O{}}{\oint\limits_{#1}#2#4\diff#3}
% Loop integral over #1
\NewDocumentCommand{\OInt}{O{} m m}{\OInt@[#1]{#2}{#3}[]}
% Loop integral over #1 of dot product of #2 and d#3 (for instance magnetic B dl)
\NewDocumentCommand{\OIntD}{O{} m m}{\OInt@[#1]{#2}{#3}[\cdot]}
\NewDocumentCommand{\OIntDV}{O{} m m}{\OIntD[#1]{\vec{#2}}{\vec{#3}}}
% Loop integral over #1 of cross product of #2 and d#3 (for instance magnetic B dl)
\NewDocumentCommand{\OIntC}{O{} m m}{\OInt@[#1]{#2}{#3}[\cross]}
\NewDocumentCommand{\OIntCV}{O{} m m}{\OIntC[#1]{\vec{#2}}{\vec{#3}}}

% Generic 2D integral
\NewDocumentCommand{\IInt}{O{} O{} m m m}{\iint\limits_{#1}^{#2}#3\diff#4\diff#5}
% Surface integral over single differential
\NewDocumentCommand{\IIntI@}{O{} O{} m m O{}}{\iint\limits_{#1}^{#2}#3#5\diff#4}
\NewDocumentCommand{\IIntI}{O{} O{} m m}{\IIntI@[#1][#2]{#3}{#4}}
% Surface integral of dot product over single differential
\NewDocumentCommand{\IIntID}{O{} O{} m m}{\IIntI@[#1][#2]{#3}{#4}[\cdot]}
\NewDocumentCommand{\IIntIDV}{O{} O{} m m}{\IIntID[#1][#2]{\vec{#3}}{\vec{#4}}}
% Surface integral of cross product over single differential
\NewDocumentCommand{\IIntIC}{O{} O{} m m}{\IIntI@[#1][#2]{#3}{#4}[\times]}
\NewDocumentCommand{\IIntICV}{O{} O{} m m}{\IIntIC[#1][#2]{\vec{#3}}{\vec{#4}}}

% Surface integral over single differential
\NewDocumentCommand{\OIIntI@}{O{} O{} m m O{}}{\oiint\limits_{#1}^{#2}#3#5\diff#4}
\NewDocumentCommand{\OIIntI}{O{} O{} m m}{\OIIntI@[#1][#2]{#3}{#4}}
% Surface integral of dot product over single differential
\NewDocumentCommand{\OIIntID}{O{} O{} m m}{\OIIntI@[#1][#2]{#3}{#4}[\cdot]}
\NewDocumentCommand{\OIIntIDV}{O{} O{} m m}{\OIIntID[#1][#2]{\vec{#3}}{\vec{#4}}}
% Surface integral of cross product over single differential
\NewDocumentCommand{\OIIntIC}{O{} O{} m m}{\OIIntI@[#1][#2]{#3}{#4}[\times]}
\NewDocumentCommand{\OIIntICV}{O{} O{} m m}{\OIIntIC[#1][#2]{\vec{#3}}{\vec{#4}}}

% Generic 3D integral
\NewDocumentCommand{\IIInt}{O{} O{} m m m m}{\iiint\limits_{#1}^{#2}#3\diff#4\diff#5\diff#6}
% Volume integral over single differential
\NewDocumentCommand{\IIIntI@}{O{} O{} m m O{}}{\iiint\limits_{#1}^{#2}#3#5\diff#4}
\NewDocumentCommand{\IIIntI}{O{} O{} m m}{\IIIntI@[#1][#2]{#3}{#4}}
\makeatother

\NewDocumentCommand{\QText}{m}{\quad\text{#1}\quad}
\NewDocumentCommand{\QQText}{m}{\qquad\text{#1}\qquad}

\NewDocumentCommand{\Floor}{m}{\left\lfloor#1\right\rfloor}
\NewDocumentCommand{\Ceil}{m}{\left\lceil#1\right\rceil}

\NewDocumentCommand{\Lim}{m m}{\lim\limits_{#1 \rightarrow #2}}
\NewDocumentCommand{\Exp}{m}{e^{#1}}
\NewDocumentCommand{\LogTen}{}{\log_{10}}
\NewDocumentCommand{\MustEqual}{}{\stackrel{!}{=}}
\NewDocumentCommand{\DefEqual}{}{\stackrel{\mathrm{def}}{=}}
\NewDocumentCommand{\Implies}{}{\quad\Rightarrow\quad}
\NewDocumentCommand{\Iff}{}{\quad\Leftrightarrow\quad}

\NewDocumentCommand{\Nuclide}{O{} O{} m}{\ce{^{#1}_{#2}#3}}

\NewDocumentCommand{\Aggregate}{m O{} O{} m}{#1\limits_{#2}^{#3} #4}
\NewDocumentCommand{\Sum}{O{} O{} m}{\Aggregate{\sum}[#1][#2]{#3}}
\NewDocumentCommand{\Product}{O{} O{} m}{\Aggregate{\prod}[#1][#2]{#3}}
\NewDocumentCommand{\CartesianProduct}{O{} O{} m}{\Aggregate{\bigtimes}[#1][#2]{#3}}

\NewDocumentCommand{\Abs}{m}{\left|#1\right|}
\NewDocumentCommand{\Max}{O{} m}{\underset{#1}{\maxop} {#2}}
\NewDocumentCommand{\Min}{O{} m}{\underset{#1}{\minop} {#2}}

\NewDocumentCommand{\Angle}{}{\sphericalangle}

\NewDocumentCommand{\Mag}{m}{\ensuremath{{#1}^{\mathrm{m}}}}
\NewDocumentCommand{\Distribution}{m m m}{#1(#2 \vert #3)}

\NewDocumentCommand{\SmallO}{m}{\mathcal{o}\left(#1\right)}
\NewDocumentCommand{\BigO}{m}{\mathcal{O}\left(#1\right)}
\NewDocumentCommand{\BigTheta}{m}{\mathcal{\Theta}\left(#1\right)}

\NewDocumentCommand{\Set}{m O{} O{}}{%
    \left\{#1\right\}\ifblank{#2}{}{_{#2}}\ifblank{#3}{}{^{#3}}%
}

% Number sets
\NewDocumentCommand{\Natural}{}{\mathbb{N}}
\NewDocumentCommand{\NaturalZero}{}{\mathbb{N}_0}
\NewDocumentCommand{\Integer}{}{\mathbb{Z}}
\NewDocumentCommand{\Rational}{}{\mathbb{Q}}
\NewDocumentCommand{\Real}{}{\mathbb{R}}
\NewDocumentCommand{\RealPos}{}{\mathbb{R}^{+}}
\NewDocumentCommand{\RealNonneg}{}{\mathbb{R}_{\geq 0}}
\NewDocumentCommand{\Complex}{}{\mathbb{C}}

% Functions
\NewDocumentCommand{\Domain}{m}{\mathrm{dom}(#1)}

% Matrices
\NewDocumentCommand{\mat}{m}{\symbf{#1}}
\NewDocumentCommand{\Transpose}{m}{#1^{\mathsf{T}}}
\NewDocumentCommand{\Inv}{m}{#1^{-1}}
\NewDocumentCommand{\Det}{m}{\left|#1\right|}
\NewDocumentCommand{\Eye}{}{\mathbb{I}}

% Intervals
\NewDocumentCommand{\IntervalCC}{m m}{\left[#1; #2\right]}
\NewDocumentCommand{\IntervalCO}{m m}{\left[#1; #2\right)}
\NewDocumentCommand{\IntervalOC}{m m}{\left(#1; #2\right]}
\NewDocumentCommand{\IntervalOO}{m m}{\left(#1; #2\right)}

\NewDocumentCommand{\kth}{m}{\ensuremath{#1^{\text{th}}}}

% Fix weird font choices
\let\tmp\phi
\let\phi\varphi
\let\varphi\tmp
\let\tmp\epsilon
\let\epsilon\varepsilon
\let\varepsilon\tmp

% Patch \left and \right with package mleftright
\let\left\mleft
\let\right\mright
